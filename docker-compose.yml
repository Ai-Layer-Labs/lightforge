services:
  db:
    image: pgvector/pgvector:pg16
    environment:
      POSTGRES_PASSWORD: postgres
      POSTGRES_USER: postgres
      POSTGRES_DB: rcrt
    ports:
      - "5432:5432"
    healthcheck:
      test: ["CMD-SHELL", "pg_isready -U postgres"]
      interval: 5s
      timeout: 5s
      retries: 10
  nats:
    image: nats:2
    command: ["-js"]
    ports:
      - "4222:4222"
      - "8222:8222"
  rcrt:
    build:
      context: .
      dockerfile: Dockerfile
      args:
        # Enable ONNX embedding by default; can be overridden: FEATURES: "embed-onnx nats"
        FEATURES: "embed-onnx nats"
    depends_on:
      db:
        condition: service_healthy
      nats:
        condition: service_started
    environment:
      DB_URL: postgres://postgres:postgres@db:5432/rcrt
      NATS_URL: nats://nats:4222
      OWNER_ID: 00000000-0000-0000-0000-000000000001
      AUTH_MODE: jwt
      AGENT_ID: 00000000-0000-0000-0000-0000000000aa
      JWT_PUBLIC_KEY_PEM: |
        -----BEGIN PUBLIC KEY-----
        MIIBIjANBgkqhkiG9w0BAQEFAAOCAQ8AMIIBCgKCAQEAuz8kjDEWaFNKNU0E2u//
        u7ggsvTz78ol5+OnUPitLecBSJAACFE1mTk7jXNir6MOF8OEdFWMv8Qm8DQoSb+5
        dwRDcQJgxIsf3nIvRWoltUaDoONsCzUlfMEikPkc/ukEBydsHi5+lyhJ7qinZZmj
        t4fwc2t+NMIByw2OlVioEl3hblZC7PkC53z3WMJjnOJ6lTdcdA/yn45jEZ6BhKcV
        wIJBfDW3fjWovi8DY0DnhS7Bgs0bupXw1zykoNmPEh9wPMCRSPqoQASRnOVOixJS
        e06617Jc8Oaw+NCzGAqTNuDkh8NK1aZuz2FC856xKOmelaxhF/SAppS5G9QIp2Ll
        SQIDAQAB
        -----END PUBLIC KEY-----
      LOCAL_KEK_BASE64: ${LOCAL_KEK_BASE64}
      OPENROUTER_API_KEY: ${OPENROUTER_API_KEY}
      OPENROUTER_REFERER: ${OPENROUTER_REFERER:-}
      OPENROUTER_SITE_TITLE: ${OPENROUTER_SITE_TITLE:-}
      EMBED_MODEL: /app/models/model.onnx
      EMBED_TOKENIZER: /app/models/tokenizer.json
    ports:
      - "8081:8080"


