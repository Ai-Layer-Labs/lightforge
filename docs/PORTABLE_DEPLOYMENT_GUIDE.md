# RCRT Portable Deployment Guide

## Overview

RCRT is fully portable and can be deployed with **custom container name prefixes** to avoid conflicts when installing in environments with multiple systems or when forking the repository.

## Quick Start with Custom Prefix

### Option 1: Environment Variable (Recommended)

```bash
# Set your custom prefix
export PROJECT_PREFIX="lightforge-"

# Run setup
./setup.sh
```

### Option 2: One-Line Install

```bash
PROJECT_PREFIX="mycompany-" ./setup.sh
```

### Option 3: Default (No Prefix)

```bash
# Just run setup normally
./setup.sh
```

## What Gets Prefixed

When you use a custom prefix (e.g., `lightforge-`), all container names are prefixed:

| Default Name | With Prefix `lightforge-` |
|-------------|---------------------------|
| `rcrt` | `lightforge-rcrt` |
| `db` | `lightforge-db` |
| `nats` | `lightforge-nats` |
| `dashboard` | `lightforge-dashboard` |
| `agent-runner` | `lightforge-agent-runner` |
| `tools-runner` | `lightforge-tools-runner` |
| `builder` | `lightforge-builder` |

## How It Works

The setup script automatically:

1. ✅ Generates `.env` with prefixed service URLs
2. ✅ Creates `docker-compose.override.yml` with custom container names
3. ✅ Configures all environment variables for inter-service communication
4. ✅ Updates extension configuration for external access

## Generated Configuration

### .env File

```bash
# Container name prefix
PROJECT_PREFIX=lightforge-

# Service URLs (auto-configured)
RCRT_BASE_URL=http://lightforge-rcrt:8080
DB_HOST=lightforge-db
DB_URL=postgresql://postgres:postgres@lightforge-db/rcrt
NATS_URL=nats://lightforge-nats:4222

# External URLs (browser/extension access - unchanged)
RCRT_EXTERNAL_URL=http://localhost:8081
DASHBOARD_EXTERNAL_URL=http://localhost:8082
BUILDER_EXTERNAL_URL=http://localhost:3000

# ... other settings
```

### docker-compose.override.yml

```yaml
# Auto-generated by setup.sh
services:
  db:
    container_name: lightforge-db
    
  nats:
    container_name: lightforge-nats
    
  rcrt:
    container_name: lightforge-rcrt
    environment:
      - DB_URL=postgresql://postgres:postgres@lightforge-db/rcrt
      - NATS_URL=nats://lightforge-nats:4222
      
  # ... other services
```

## Multi-Deployment Scenarios

### Scenario 1: Multiple Environments on Same Host

```bash
# Development environment
PROJECT_PREFIX="dev-" ./setup.sh

# Staging environment (in different directory)
cd ../rcrt-staging
PROJECT_PREFIX="staging-" ./setup.sh

# Production environment
cd ../rcrt-prod
PROJECT_PREFIX="prod-" ./setup.sh
```

Each will have isolated containers and can run simultaneously.

### Scenario 2: Multiple Projects Using RCRT

```bash
# Project A
cd ~/projects/project-a
PROJECT_PREFIX="projecta-" ./setup.sh

# Project B
cd ~/projects/project-b
PROJECT_PREFIX="projectb-" ./setup.sh
```

### Scenario 3: Forked Repository

When forking RCRT for your company:

```bash
# Clone your fork
git clone https://github.com/yourcompany/rcrt-fork.git
cd rcrt-fork

# Setup with your company prefix
PROJECT_PREFIX="yourcompany-" ./setup.sh
```

## Changing Prefix After Installation

If you need to change the prefix after initial setup:

1. **Stop all services:**
   ```bash
   docker compose down
   ```

2. **Remove generated files:**
   ```bash
   rm docker-compose.override.yml
   rm .env
   ```

3. **Run setup with new prefix:**
   ```bash
   PROJECT_PREFIX="newprefix-" ./setup.sh
   ```

## Extension Configuration

The browser extension automatically detects the correct RCRT server URL:

1. **During build:** Uses `VITE_RCRT_BASE_URL` from `.env`
2. **At runtime:** Checks Chrome storage for custom URL
3. **Fallback:** Uses `http://127.0.0.1:8081`

To manually set extension URL:

```javascript
// In browser console after installing extension
chrome.storage.local.set({ 
  rcrtBaseUrl: 'http://localhost:8081' 
});
```

## Networking Considerations

### Internal Communication (Docker Network)

Services communicate using container names:
- ✅ `http://lightforge-rcrt:8080` (internal)
- ✅ `postgresql://postgres:postgres@lightforge-db/rcrt`
- ✅ `nats://lightforge-nats:4222`

### External Access (Host Machine)

Ports remain the same for external access:
- ✅ Dashboard: `http://localhost:8082`
- ✅ RCRT API: `http://localhost:8081`
- ✅ Builder: `http://localhost:3000`

This means the extension and browser always connect to `localhost` ports, regardless of internal container names.

## Troubleshooting

### Services Can't Find Each Other

**Problem:** `agent-runner` can't connect to `rcrt`

**Solution:** Check that `docker-compose.override.yml` was generated:

```bash
# Verify override exists
cat docker-compose.override.yml

# Check environment variables
docker compose config | grep RCRT_BASE_URL
```

### Extension Can't Connect

**Problem:** Extension shows "Not connected to RCRT"

**Solution:** Extension always connects to `localhost` ports:

```bash
# Verify port mapping
docker compose ps | grep rcrt
# Should show: 0.0.0.0:8081->8080/tcp

# Test connection
curl http://localhost:8081/health
```

### Wrong Container Names

**Problem:** Containers still using default names

**Solution:** Ensure you set `PROJECT_PREFIX` before running setup:

```bash
# Check current prefix
echo $PROJECT_PREFIX

# Re-run setup with prefix
docker compose down
rm docker-compose.override.yml
PROJECT_PREFIX="lightforge-" ./setup.sh
```

## Advanced: Manual Configuration

If you prefer to configure manually without the setup script:

### 1. Create docker-compose.override.yml

```yaml
services:
  db:
    container_name: myprefix-db
    
  rcrt:
    container_name: myprefix-rcrt
    environment:
      - DB_URL=postgresql://postgres:postgres@myprefix-db/rcrt
      - NATS_URL=nats://myprefix-nats:4222
    depends_on:
      - myprefix-db
      - myprefix-nats
```

### 2. Update .env

```bash
PROJECT_PREFIX=myprefix-
RCRT_BASE_URL=http://myprefix-rcrt:8080
DB_HOST=myprefix-db
DB_URL=postgresql://postgres:postgres@${DB_HOST}/rcrt
NATS_URL=nats://myprefix-nats:4222
```

### 3. Start Services

```bash
docker compose up -d
```

## Best Practices

### 1. Choose Clear Prefixes

✅ **Good:**
- `dev-` - Development environment
- `staging-` - Staging environment
- `prod-` - Production (or no prefix)
- `companyname-` - Company deployment
- `projectname-` - Project-specific

❌ **Avoid:**
- `x-` - Too generic
- `test123-` - Not descriptive
- `my-` - Ambiguous

### 2. Document Your Prefix

Add to your forked README:

```markdown
## Our Deployment

This fork uses the prefix: `ourcompany-`

To deploy:
```bash
PROJECT_PREFIX="ourcompany-" ./setup.sh
```
```

### 3. Consistent Naming

Use the same prefix pattern across:
- Container names
- Network names (if custom)
- Volume names (if custom)
- Documentation

### 4. Environment Isolation

For true isolation, also customize:

```bash
# Different database names
DB_URL=postgresql://postgres:postgres@lightforge-db/rcrt_dev

# Different NATS subjects
WORKSPACE=lightforge:agents

# Different owner IDs
OWNER_ID=12345678-1234-1234-1234-123456789012
```

## Verification Checklist

After deployment with custom prefix:

- [ ] All containers have correct prefix: `docker ps | grep lightforge-`
- [ ] Services can communicate: `docker compose logs | grep "Connected to"`
- [ ] Dashboard accessible: `curl http://localhost:8082`
- [ ] RCRT API accessible: `curl http://localhost:8081/health`
- [ ] Extension connects: Check extension popup
- [ ] Agents loading: `docker compose logs agent-runner | grep "agents"`
- [ ] Tools available: `docker compose logs tools-runner | grep "tools available"`

## Migration from Default to Prefixed

If you already have a running RCRT with default names:

1. **Export data** (if needed):
   ```bash
   docker exec db pg_dump -U postgres rcrt > backup.sql
   ```

2. **Stop current deployment:**
   ```bash
   docker compose down -v  # -v removes volumes
   ```

3. **Setup with prefix:**
   ```bash
   PROJECT_PREFIX="myprefix-" ./setup.sh
   ```

4. **Import data** (if needed):
   ```bash
   docker exec -i myprefix-db psql -U postgres rcrt < backup.sql
   ```

## Kubernetes Deployment

For Kubernetes, use namespace + labels instead:

```yaml
apiVersion: apps/v1
kind: Deployment
metadata:
  name: rcrt-server
  namespace: lightforge-rcrt  # Namespace provides isolation
  labels:
    app: rcrt
    env: production
    project: lightforge
```

## CI/CD Integration

### GitHub Actions

```yaml
- name: Deploy RCRT
  env:
    PROJECT_PREFIX: ${{ secrets.RCRT_PREFIX }}
  run: |
    export PROJECT_PREFIX
    ./setup.sh
```

### GitLab CI

```yaml
deploy:
  script:
    - export PROJECT_PREFIX="${CI_ENVIRONMENT_NAME}-"
    - ./setup.sh
```

## Support

For issues with portable deployment:

1. Check generated files: `.env` and `docker-compose.override.yml`
2. Verify container names: `docker ps`
3. Test connectivity: `docker compose logs [service]`
4. Review documentation: [SYSTEM_ARCHITECTURE_OVERVIEW.md](./SYSTEM_ARCHITECTURE_OVERVIEW.md)

---

**Version**: 1.0  
**Last Updated**: 2024  
**Related**: QUICK_REFERENCE.md, SYSTEM_ARCHITECTURE_OVERVIEW.md
