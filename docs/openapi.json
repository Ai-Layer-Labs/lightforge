{
  "openapi": "3.0.3",
  "info": {
    "title": "RCRT API",
    "version": "0.1.0",
    "description": "Right Context Right Time (RCRT) service. Provides minimal context packets (breadcrumbs), subscriptions, event fanout (NATS/SSE/webhooks), ACL/RLS, vector search, and secrets handling. Unless otherwise stated, endpoints require agent JWT (or dev AUTH_MODE=disabled)."
  },
  "servers": [{ "url": "/" }],
  "paths": {
    "/health": {
      "get": {
        "summary": "Health",
        "description": "Liveness/readiness probe. Returns 'ok' when the API is serving requests.",
        "responses": { "200": { "description": "ok", "content": { "text/plain": { "schema": { "type": "string" } } } } }
      }
    },
    "/breadcrumbs": {
      "post": {
        "summary": "Create breadcrumb",
        "description": "Create a minimal, persistent breadcrumb. Emits events to matching subscribers. Requires role: emitter or curator. If supplied, Idempotency-Key deduplicates identical requests.",
        "requestBody": { "required": true, "content": { "application/json": { "schema": { "$ref": "#/components/schemas/BreadcrumbCreate" } } } },
        "parameters": [{ "name": "Idempotency-Key", "in": "header", "schema": { "type": "string" } }],
        "responses": { "200": { "description": "Created", "content": { "application/json": { "schema": { "$ref": "#/components/schemas/CreateResp" } } } } }
      },
      "get": {
        "summary": "List breadcrumbs",
        "description": "List breadcrumbs visible to the caller within the owner scope. Optional tag filter.",
        "parameters": [{ "name": "tag", "in": "query", "schema": { "type": "string" } }],
        "responses": { "200": { "description": "List", "content": { "application/json": { "schema": { "type": "array", "items": { "$ref": "#/components/schemas/ListItem" } } } } } }
      }
    },
    "/breadcrumbs/{id}": {
      "parameters": [{ "$ref": "#/components/parameters/BreadcrumbId" }],
      "get": {
        "summary": "Get breadcrumb context",
        "description": "Fetch minimal context-view (redacted) of a breadcrumb for LLM usage. Access controlled by visibility/ACL.",
        "responses": { "200": { "description": "Context", "content": { "application/json": { "schema": { "$ref": "#/components/schemas/BreadcrumbContext" } } } }, "404": { "description": "Not found" } }
      },
      "patch": {
        "summary": "Update breadcrumb",
        "description": "Partial update of breadcrumb fields. Include If-Match header with current version (e.g., \"5\") to ensure optimistic concurrency. Appends an entry to history and emits events.",
        "parameters": [{ "$ref": "#/components/parameters/IfMatch" }],
        "requestBody": { "required": true, "content": { "application/json": { "schema": { "$ref": "#/components/schemas/BreadcrumbUpdate" } } } },
        "responses": { "200": { "description": "Updated", "content": { "application/json": { "schema": { "$ref": "#/components/schemas/OkResp" } } } }, "412": { "description": "Version mismatch" } }
      },
      "delete": {
        "summary": "Delete breadcrumb",
        "description": "Hard-delete the breadcrumb (soft-delete optional in future). Emits no further events.",
        "responses": { "200": { "description": "Deleted", "content": { "application/json": { "schema": { "$ref": "#/components/schemas/OkResp" } } } }, "404": { "description": "Not found" } }
      }
    },
    "/breadcrumbs/{id}/full": {
      "parameters": [{ "$ref": "#/components/parameters/BreadcrumbId" }],
      "get": {
        "summary": "Get full breadcrumb",
        "description": "Fetch full-view of a breadcrumb including operational metadata. Requires ACL 'read_full' or curator role.",
        "responses": { "200": { "description": "Full", "content": { "application/json": { "schema": { "$ref": "#/components/schemas/BreadcrumbFull" } } } }, "403": { "description": "Forbidden" }, "404": { "description": "Not found" } }
      }
    },
    "/breadcrumbs/{id}/history": {
      "parameters": [{ "$ref": "#/components/parameters/BreadcrumbId" }],
      "get": {
        "summary": "Get history",
        "description": "List historical versions with context snapshots and audit details.",
        "responses": { "200": { "description": "History", "content": { "application/json": { "schema": { "type": "array", "items": { "$ref": "#/components/schemas/HistoryItem" } } } } } }
      }
    },
    "/breadcrumbs/search": {
      "get": {
        "summary": "Vector search",
        "description": "Nearest-neighbor search over embeddings (auto-embed with 'q' or pass explicit 'qvec'). Filterable by tag.",
        "parameters": [{ "name": "q", "in": "query", "schema": { "type": "string" } }, { "name": "qvec", "in": "query", "schema": { "type": "string" } }, { "name": "nn", "in": "query", "schema": { "type": "integer" } }, { "name": "tag", "in": "query", "schema": { "type": "string" } }],
        "responses": { "200": { "description": "Results", "content": { "application/json": { "schema": { "type": "array", "items": { "$ref": "#/components/schemas/ListItem" } } } } } }
      }
    },
    "/subscriptions/selectors": {
      "post": {
        "summary": "Create selector",
        "description": "Create a selector subscription for the caller agent. Supports tag filters, optional schema name, and simple context_match rules (eq, contains_any). Requires role: subscriber or curator.",
        "requestBody": { "required": true, "content": { "application/json": { "schema": { "$ref": "#/components/schemas/Selector" } } } },
        "responses": { "200": { "description": "Created", "content": { "application/json": { "schema": { "$ref": "#/components/schemas/SelectorSubscription" } } } } }
      },
      "get": {
        "summary": "List selectors",
        "description": "List selector subscriptions owned by the caller agent.",
        "responses": { "200": { "description": "List", "content": { "application/json": { "schema": { "type": "array", "items": { "$ref": "#/components/schemas/SelectorSubscription" } } } } } }
      }
    },
    "/events/stream": {
      "get": {
        "summary": "SSE stream",
        "description": "Server-Sent Events stream of authorized events (owner-filtered and per-agent). Includes periodic ping events for liveness.",
        "responses": { "200": { "description": "SSE", "content": { "text/event-stream": {} } } }
      }
    },
    "/agents/{id}": {
      "parameters": [{ "$ref": "#/components/parameters/AgentId" }],
      "post": {
        "summary": "Register agent",
        "description": "Upsert agent metadata and roles within the tenant. Caller must be the agent or curator.",
        "requestBody": { "required": true, "content": { "application/json": { "schema": { "$ref": "#/components/schemas/AgentRegReq" } } } },
        "responses": { "200": { "description": "OK", "content": { "application/json": { "schema": { "$ref": "#/components/schemas/OkResp" } } } } }
      }
    },
    "/agents/{id}/secret": {
      "parameters": [{ "$ref": "#/components/parameters/AgentId" }],
      "post": {
        "summary": "Set webhook secret",
        "description": "Set or update agent webhook HMAC secret used to sign deliveries.",
        "requestBody": { "required": true, "content": { "application/json": { "schema": { "$ref": "#/components/schemas/SecretReq" } } } },
        "responses": { "200": { "description": "OK", "content": { "application/json": { "schema": { "$ref": "#/components/schemas/OkResp" } } } } }
      }
    },
    "/agents/{id}/webhooks": {
      "parameters": [{ "$ref": "#/components/parameters/AgentId" }],
      "post": {
        "summary": "Register webhook",
        "description": "Register or reactivate a webhook for an agent (deduped by URL).",
        "requestBody": { "required": true, "content": { "application/json": { "schema": { "$ref": "#/components/schemas/WebhookReq" } } } },
        "responses": { "200": { "description": "OK", "content": { "application/json": { "schema": { "$ref": "#/components/schemas/IdResp" } } } } }
      },
      "get": {
        "summary": "List webhooks",
        "description": "List active webhooks for an agent.",
        "responses": { "200": { "description": "List", "content": { "application/json": { "schema": { "type": "array", "items": { "$ref": "#/components/schemas/WebhookItem" } } } } } }
      }
    },
    "/agents/{id}/webhooks/{wid}": {
      "parameters": [{ "$ref": "#/components/parameters/AgentId" }, { "$ref": "#/components/parameters/WebhookId" }],
      "delete": {
        "summary": "Deactivate webhook",
        "description": "Deactivate (soft-delete) a webhook by ID.",
        "responses": { "200": { "description": "OK", "content": { "application/json": { "schema": { "$ref": "#/components/schemas/OkResp" } } } } }
      }
    },
    "/tenants/{id}": {
      "parameters": [{ "$ref": "#/components/parameters/TenantId" }],
      "post": {
        "summary": "Ensure tenant",
        "description": "Idempotent creation/update of a tenant row (for dev/local bootstrapping).",
        "requestBody": { "required": true, "content": { "application/json": { "schema": { "$ref": "#/components/schemas/TenantReq" } } } },
        "responses": { "200": { "description": "OK", "content": { "application/json": { "schema": { "$ref": "#/components/schemas/OkResp" } } } } }
      }
    },
    "/secrets": {
      "post": {
        "summary": "Create secret",
        "description": "Create an envelope-encrypted secret using a local KEK (DEK per-secret; AES-GCM for value, XChaCha20-Poly1305 for DEK wrap). Requires curator.",
        "requestBody": { "required": true, "content": { "application/json": { "schema": { "$ref": "#/components/schemas/SecretCreateReq" } } } },
        "responses": { "200": { "description": "Created", "content": { "application/json": { "schema": { "$ref": "#/components/schemas/IdResp" } } } } }
      }
    },
    "/secrets/{id}/decrypt": {
      "parameters": [{ "$ref": "#/components/parameters/SecretId" }],
      "post": {
        "summary": "Decrypt secret",
        "description": "Decrypt and return the plaintext secret; audited with agent_id and reason.",
        "requestBody": { "required": true, "content": { "application/json": { "schema": { "$ref": "#/components/schemas/SecretDecryptReq" } } } },
        "responses": { "200": { "description": "Decrypted", "content": { "application/json": { "schema": { "$ref": "#/components/schemas/SecretValue" } } } } }
      }
    },
    "/admin/purge": {
      "post": {
        "summary": "Purge expired TTL",
        "description": "Curator-only: delete all expired TTL breadcrumbs for current owner.",
        "responses": { "200": { "description": "Purged", "content": { "application/json": { "schema": { "$ref": "#/components/schemas/PurgeResp" } } } } }
      }
    },
    "/dlq": {
      "get": {
        "summary": "List webhook DLQ",
        "description": "Curator-only: list failed webhook deliveries queued for manual retry.",
        "responses": { "200": { "description": "List", "content": { "application/json": { "schema": { "type": "array", "items": { "$ref": "#/components/schemas/DlqItem" } } } } } }
      }
    },
    "/dlq/{id}/retry": {
      "parameters": [{ "$ref": "#/components/parameters/DlqId" }],
      "post": {
        "summary": "Retry DLQ item",
        "description": "Curator-only: requeue a single DLQ webhook delivery and remove it from DLQ.",
        "responses": { "200": { "description": "Requeued", "content": { "application/json": { "schema": { "$ref": "#/components/schemas/OkResp" } } } } }
      }
    }
  },
  "components": {
    "parameters": {
      "BreadcrumbId": { "name": "id", "in": "path", "required": true, "schema": { "type": "string", "format": "uuid" } },
      "AgentId": { "name": "id", "in": "path", "required": true, "schema": { "type": "string", "format": "uuid" } },
      "WebhookId": { "name": "wid", "in": "path", "required": true, "schema": { "type": "string", "format": "uuid" } },
      "TenantId": { "name": "id", "in": "path", "required": true, "schema": { "type": "string", "format": "uuid" } },
      "SecretId": { "name": "id", "in": "path", "required": true, "schema": { "type": "string", "format": "uuid" } },
      "DlqId": { "name": "id", "in": "path", "required": true, "schema": { "type": "string", "format": "uuid" } },
      "IfMatch": { "name": "If-Match", "in": "header", "schema": { "type": "string" } }
    },
    "schemas": {
      "OkResp": { "type": "object", "properties": { "ok": { "type": "boolean" } } },
      "IdResp": { "type": "object", "properties": { "id": { "type": "string", "format": "uuid" } } },
      "CreateResp": { "$ref": "#/components/schemas/IdResp" },
      "PurgeResp": { "type": "object", "properties": { "purged": { "type": "integer" } } },
      "ListItem": { "type": "object", "properties": { "id": { "type": "string", "format": "uuid" }, "title": { "type": "string" }, "tags": { "type": "array", "items": { "type": "string" } }, "version": { "type": "integer" }, "updated_at": { "type": "string", "format": "date-time" } } },
      "BreadcrumbCreate": { "type": "object", "required": ["title","context","tags"], "properties": { "title": { "type": "string" }, "context": { "type": "object", "additionalProperties": true }, "tags": { "type": "array", "items": { "type": "string" } }, "schema_name": { "type": "string" }, "visibility": { "type": "string", "enum": ["public","team","private"] }, "sensitivity": { "type": "string", "enum": ["low","pii","secret"] }, "ttl": { "type": "string", "format": "date-time" } } },
      "BreadcrumbUpdate": { "type": "object", "properties": { "title": { "type": "string" }, "context": { "type": "object", "additionalProperties": true }, "tags": { "type": "array", "items": { "type": "string" } }, "schema_name": { "type": "string" }, "visibility": { "type": "string", "enum": ["public","team","private"] }, "sensitivity": { "type": "string", "enum": ["low","pii","secret"] }, "ttl": { "type": "string", "format": "date-time" } } },
      "BreadcrumbContext": { "type": "object", "properties": { "id": { "type": "string", "format": "uuid" }, "title": { "type": "string" }, "context": { "type": "object", "additionalProperties": true }, "tags": { "type": "array", "items": { "type": "string" } }, "version": { "type": "integer" }, "updated_at": { "type": "string", "format": "date-time" } } },
      "BreadcrumbFull": { "type": "object", "properties": { "id": { "type": "string", "format": "uuid" }, "owner_id": { "type": "string", "format": "uuid" }, "title": { "type": "string" }, "context": { "type": "object", "additionalProperties": true }, "tags": { "type": "array", "items": { "type": "string" } }, "schema_name": { "type": "string" }, "visibility": { "type": "string" }, "sensitivity": { "type": "string" }, "version": { "type": "integer" }, "checksum": { "type": "string" }, "ttl": { "type": "string", "format": "date-time" }, "created_at": { "type": "string", "format": "date-time" }, "updated_at": { "type": "string", "format": "date-time" }, "created_by": { "type": "string", "format": "uuid" }, "updated_by": { "type": "string", "format": "uuid" }, "size_bytes": { "type": "integer" }, "embedding": { "type": "array", "items": { "type": "number" } } } },
      "Selector": { "type": "object", "properties": { "any_tags": { "type": "array", "items": { "type": "string" } }, "all_tags": { "type": "array", "items": { "type": "string" } }, "schema_name": { "type": "string" }, "context_match": { "type": "array", "items": { "$ref": "#/components/schemas/ContextMatch" } } } },
      "ContextMatch": { "type": "object", "properties": { "path": { "type": "string" }, "op": { "type": "string", "enum": ["eq","contains_any","gt","lt"] }, "value": { } }, "required": ["path","op","value"] },
      "SelectorSubscription": { "type": "object", "properties": { "id": { "type": "string", "format": "uuid" }, "owner_id": { "type": "string", "format": "uuid" }, "agent_id": { "type": "string", "format": "uuid" }, "selector": { "$ref": "#/components/schemas/Selector" } } },
      "WebhookReq": { "type": "object", "properties": { "url": { "type": "string", "format": "uri" } }, "required": ["url"] },
      "WebhookItem": { "type": "object", "properties": { "id": { "type": "string", "format": "uuid" }, "url": { "type": "string", "format": "uri" } } },
      "AgentRegReq": { "type": "object", "properties": { "roles": { "type": "array", "items": { "type": "string" } } }, "required": ["roles"] },
      "TenantReq": { "type": "object", "properties": { "name": { "type": "string" } }, "required": ["name"] },
      "SecretReq": { "type": "object", "properties": { "secret": { "type": "string" } }, "required": ["secret"] },
      "SecretCreateReq": { "type": "object", "properties": { "name": { "type": "string" }, "scope_type": { "type": "string" }, "scope_id": { "type": "string", "format": "uuid" }, "value": { "type": "string" } }, "required": ["name","scope_type","value"] },
      "SecretDecryptReq": { "type": "object", "properties": { "reason": { "type": "string" } } },
      "SecretValue": { "type": "object", "properties": { "value": { "type": "string" } } },
      "DlqItem": { "type": "object", "properties": { "id": { "type": "string", "format": "uuid" }, "agent_id": { "type": "string", "format": "uuid" }, "url": { "type": "string" }, "payload": { }, "last_error": { "type": "string" }, "created_at": { "type": "string", "format": "date-time" } } }
    }
  }
}


